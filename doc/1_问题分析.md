# 问题分析报告

tao是基于Go语言的单服务器高性能网络库，服务端工程师可以通过该网络库构建基于TCP协议的长连接服务。

## 问题陈述

在3个月的时间内，通过需求、分析、设计和编码，开发一款基于Go语言的网络编程库，包括服务端、客户端、定时任务、日志，支持常见序列化数据结构，并提供examples，目标是实现基于Reactor模式的单服务器高性能长连接网络编程库。

## 3W2S1R分析

**网络编程库的提出者和使用者**主要是需要开发网络服务的Go程序员，他们需要使用这个库开发服务端（和客户端）以实现长连接方式的网络数据通信。

在一般的场景下，一个服务器往往要服务于成千上百个客户端连接。然而服务器的资源是有限的，如何将单服务器的性能发挥到极致，使其能够服务尽可能多的客户端连接，实现单机高并发，是**问题提出的背景**。得益于Go语言特有的goroutine轻量级线程，第一版的tao网络编程库采用的网络编程模型是TPC模型（thread per connection）：每个网络连接开辟了三个线程，一个负责读（read），一个负责写（write），还有一个负责执行业务逻辑（process）。这样的实现方式并没有做到计算高性能，在线程的使用上有些浪费，并不能移植到其他编程语言中。第二版的tao要解决上述问题，基于Reactor模式来实现“one loop per thread”的网络编程模型，并在此基础上提供定时任务和高性能日志，并支持常见的序列化数据结构如Protobuf。网络库还会提供丰富的示例告诉使用者如何实现各种各样的常见网络服务，如Discard和Echo等等。

该问题需要在3个月（90天）左右的时间解决。其中需求建模、分析建模和设计建模需要60天时间，编码实现需要30天时间。

**问题成功解决的标准**是Go程序员能够通过tao网络库开发非平凡的、基于长连接的网络服务。比如物联网使用场景下，有多个智能门锁需要与服务端基于心跳保持长连接，服务器转发手机客户端的开锁指令，实现智能锁的远程开门。比如网络游戏，各客户端通过连接网关服务器进行联网对战，网关服务器将客户请求转发给其他服务器实现业务逻辑，比如登录认证服务器、购买装备和联机对战等等。

**需要解决的问题**包括：

1. 基于Reactor模式实现核心网络库，包括server和client，提供“单Reactor单线程”、“单Reactor多线程”和“多Reactor多线程”多种机制；
2. 通过工作者线程池来处理具体的业务逻辑；
3. 要支持诸如Protobuf这样的序列化数据结构实现编解码处理消息；
4. 开发高性能网络日志；
5. 实现服务端的定时任务机制；
6. 提供一定数量的例子演示如何使用tao库开发常见的网络服务，包括服务端和客户端；
7. 跨平台支持Linux和MacOS。

网络编程库与高层开发是相辅相成的。网络编程库关注的是底层的网络细节，高层的开发则关注业务逻辑的实现；编写良好的网络编程库为业务逻辑开发提供最大价值的支持，业务逻辑开发则体现了网络编程库存在的意义。

在解决问题的过程中要面临很多**风险和挑战**。开发一个网络编程库，需要对网络编程有深入的理解，涉及到TCP协议、socket编程和IO模型。除此之外，需要对操作系统的进程模型有深入的认识，特别是并发多线程的各种同步操作。最重要的一点是要对epoll、kqueue和reactor模式非常熟悉，这其中可能还涉及到与“并发和联网对象模式”相关的其他设计模式，这些都需要通过大量的阅读来学习掌握，难度非常大。

要应对这些挑战，仍然还是采用“矛盾分析法”的思路。先提出问题，然后分析问题，最后综合起来指明问题的性质，提供解决方案。“调查研究”的方法是贯穿整个过程始终的。在战争中学习战争，在实践中不断加深对网络编程的理解和认识。

## 需求清单

* 通过网络编程库实现Echo服务
* 通过网络编程库实现Discard服务
* 通过网络编程库实现Time服务
* 通过网络编程库实现聊天服务